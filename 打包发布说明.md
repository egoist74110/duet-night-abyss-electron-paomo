# DNA Automator 打包和发布指南

## 📦 打包流程

### 1. 准备工作

#### 1.1 创建应用图标
在项目根目录创建 `build` 文件夹,并准备图标文件:

```
项目根目录/
  └── build/
      └── icon.ico  (Windows图标,推荐尺寸: 256x256)
```

**如何制作图标**:
- 使用在线工具: https://www.icoconverter.com/
- 上传一张 PNG 图片(推荐 512x512 或更大)
- 下载生成的 `.ico` 文件
- 将文件命名为 `icon.ico` 并放到 `build` 文件夹

**临时方案**: 如果暂时没有图标,可以先跳过这一步,打包时会使用 Electron 默认图标。

#### 1.2 安装 Python 依赖
确保 Python 环境已经配置好所有依赖:

```bash
pip install -r py_engine/requirements.txt
```

#### 1.3 检查项目配置
确保 `package.json` 中的信息正确:
- `author`: 你的名字或团队名称
- `description`: 应用描述
- `version`: 版本号(如 0.1.0)

### 2. 执行打包

#### 方式1: 完整打包(推荐)
```bash
npm run build
```

这个命令会:
1. 编译 TypeScript 代码
2. 构建 Vue 前端
3. 编译 Electron 主进程
4. 使用 electron-builder 打包成安装程序

#### 方式2: 只打包 Windows 版本
```bash
npm run build:win
```

### 3. 打包输出

打包完成后,会在项目根目录生成 `release` 文件夹:

```
release/
  ├── DNA Automator Setup 0.1.0.exe  (安装程序,分发给用户)
  ├── win-unpacked/                   (未打包的文件,用于测试)
  └── builder-effective-config.yaml   (构建配置,可忽略)
```

**重要文件**:
- `DNA Automator Setup 0.1.0.exe` - 这就是你要分发给用户的安装包!

### 4. 测试安装包

在打包完成后,务必测试安装包:

1. **测试安装流程**:
   - 双击 `DNA Automator Setup 0.1.0.exe`
   - 选择安装路径(默认是 `C:\Users\用户名\AppData\Local\Programs\DNA Automator`)
   - 完成安装

2. **测试管理员权限**:
   - 找到安装后的程序(默认在桌面或开始菜单有快捷方式)
   - 右键点击快捷方式 → 属性
   - 切换到"兼容性"选项卡
   - 勾选"以管理员身份运行此程序"
   - 点击"确定"

3. **测试功能**:
   - 启动程序,检查所有功能是否正常
   - 测试窗口检测、置顶、快捷键等功能
   - 检查 Python 引擎是否正常启动

## 🚀 发布给用户

### 发布方式

#### 方式1: 直接分发(适合小范围测试)
- 将 `DNA Automator Setup 0.1.0.exe` 上传到网盘(百度网盘、阿里云盘等)
- 分享下载链接给用户

#### 方式2: GitHub Release(推荐)
1. 在 GitHub 仓库创建新的 Release
2. 上传 `DNA Automator Setup 0.1.0.exe`
3. 编写更新日志
4. 发布 Release

#### 方式3: 自建下载服务器
- 将安装包上传到自己的服务器
- 提供下载链接

### 用户安装指南

为用户提供以下安装说明:

---

## DNA Automator 安装指南(用户版)

### 系统要求
- Windows 10/11 (64位)
- Python 3.10+ (如果没有,安装包会提示安装)
- 至少 500MB 可用磁盘空间

### 安装步骤

1. **下载安装包**
   - 下载 `DNA Automator Setup 0.1.0.exe`

2. **运行安装程序**
   - 双击 `DNA Automator Setup 0.1.0.exe`
   - 如果出现 Windows 安全提示,点击"更多信息" → "仍要运行"
   - 选择安装路径(推荐使用默认路径)
   - 点击"安装"

3. **设置管理员权限(重要!)**
   - 安装完成后,在桌面找到 `DNA Automator` 快捷方式
   - 右键点击快捷方式 → 选择"属性"
   - 切换到"兼容性"选项卡
   - 勾选"以管理员身份运行此程序"
   - 点击"应用" → "确定"

4. **首次启动**
   - 双击桌面快捷方式启动程序
   - 如果弹出 UAC 提示,点击"是"
   - 等待程序启动完成

5. **安装 Python 依赖(如果需要)**
   - 如果程序提示缺少 Python 依赖
   - 运行安装目录下的 `setup_python.bat`
   - 等待依赖安装完成

### 卸载程序
- 方式1: 控制面板 → 程序和功能 → 找到 DNA Automator → 卸载
- 方式2: 开始菜单 → DNA Automator → Uninstall DNA Automator

---

## 🔧 打包配置说明

### electron-builder 配置详解

在 `package.json` 中的 `build` 字段:

```json
{
  "build": {
    "appId": "com.dna.automator",           // 应用唯一标识
    "productName": "DNA Automator",         // 产品名称(显示给用户)
    "directories": {
      "output": "release"                   // 输出目录
    },
    "files": [                              // 需要打包的文件
      "dist/**/*",                          // Vue 构建产物
      "dist-electron/**/*",                 // Electron 主进程
      "py_engine/**/*",                     // Python 引擎
      "static/**/*",                        // 静态资源
      "mods/**/*"                           // 模组文件
    ],
    "win": {
      "target": [
        {
          "target": "nsis",                 // 使用 NSIS 安装器
          "arch": ["x64"]                   // 64位架构
        }
      ],
      "icon": "build/icon.ico",             // 应用图标
      "requestedExecutionLevel": "requireAdministrator"  // 要求管理员权限
    },
    "nsis": {
      "oneClick": false,                    // 不使用一键安装(让用户选择路径)
      "allowToChangeInstallationDirectory": true,  // 允许用户选择安装路径
      "allowElevation": true,               // 允许提升权限
      "createDesktopShortcut": true,        // 创建桌面快捷方式
      "createStartMenuShortcut": true,      // 创建开始菜单快捷方式
      "shortcutName": "DNA Automator",      // 快捷方式名称
      "deleteAppDataOnUninstall": false,    // 卸载时不删除用户数据
      "perMachine": false,                  // 为当前用户安装(不是所有用户)
      "runAfterFinish": true                // 安装完成后运行程序
    },
    "extraResources": [                     // 额外资源文件
      {
        "from": "py_engine",
        "to": "py_engine",
        "filter": ["**/*"]
      },
      {
        "from": "static",
        "to": "static",
        "filter": ["**/*"]
      },
      {
        "from": "mods",
        "to": "mods",
        "filter": ["**/*"]
      }
    ]
  }
}
```

### 关键配置项说明

#### 1. `requestedExecutionLevel: "requireAdministrator"`
- 这个配置会在打包时将管理员权限要求写入 exe 文件的清单(manifest)
- 用户双击运行时,Windows 会自动弹出 UAC 提示
- 用户点击"是"后,程序就以管理员权限运行

#### 2. `oneClick: false`
- 设置为 false 表示使用传统的安装向导
- 用户可以选择安装路径、是否创建快捷方式等
- 如果设置为 true,则是一键安装(无法选择路径)

#### 3. `perMachine: false`
- false: 为当前用户安装(推荐)
  - 安装路径: `C:\Users\用户名\AppData\Local\Programs\`
  - 不需要管理员权限安装
- true: 为所有用户安装
  - 安装路径: `C:\Program Files\`
  - 需要管理员权限安装

#### 4. `extraResources`
- 将 Python 引擎、静态资源、模组文件打包到安装包
- 这些文件会被复制到安装目录的 `resources` 文件夹

## 📝 常见问题

### Q1: 打包时提示找不到图标文件
**解决方案**: 
- 创建 `build` 文件夹并放入 `icon.ico` 文件
- 或者在 `package.json` 中删除 `"icon": "build/icon.ico"` 这一行

### Q2: 打包后的程序无法启动 Python 引擎
**原因**: Python 文件路径不正确

**解决方案**: 
在 `electron/main.ts` 中修改 Python 路径:

```typescript
// 开发模式
const scriptPath = join(__dirname, '../py_engine/main.py')

// 生产模式(打包后)
const scriptPath = app.isPackaged
  ? join(process.resourcesPath, 'py_engine/main.py')
  : join(__dirname, '../py_engine/main.py')
```

### Q3: 用户安装后没有管理员权限
**原因**: 
- `requestedExecutionLevel` 配置可能不生效
- 用户可能点击了 UAC 提示的"否"

**解决方案**:
- 让用户手动设置快捷方式的管理员权限(右键 → 属性 → 兼容性)
- 或者在程序启动时检测权限并提示用户

### Q4: 打包后的安装包太大
**原因**: 
- Electron 本身比较大(约 150MB)
- Python 依赖库也会占用空间

**优化方案**:
1. 使用 `asar` 压缩(electron-builder 默认启用)
2. 排除不必要的文件:
   ```json
   "files": [
     "!**/*.map",           // 排除 source map
     "!**/node_modules/*/{CHANGELOG.md,README.md,README,readme.md,readme}"
   ]
   ```
3. 考虑使用在线安装器(下载时才下载 Python 依赖)

### Q5: 如何更新版本号
修改 `package.json` 中的 `version` 字段:
```json
{
  "version": "0.2.0"  // 从 0.1.0 改为 0.2.0
}
```

打包后的文件名会自动变为 `DNA Automator Setup 0.2.0.exe`

## 🎯 下一步优化

### 1. 自动更新功能
使用 `electron-updater` 实现自动更新:
- 用户启动程序时自动检查更新
- 发现新版本时提示用户下载
- 后台下载并安装更新

### 2. 代码签名
购买代码签名证书并签名 exe 文件:
- 避免 Windows 安全警告
- 提升用户信任度
- 证书费用约 $100-300/年

### 3. 多语言支持
- 支持中文和英文界面
- 根据系统语言自动切换

### 4. 崩溃报告
集成崩溃报告工具:
- 自动收集崩溃日志
- 帮助快速定位和修复问题

## 📚 参考资料

- [electron-builder 官方文档](https://www.electron.build/)
- [NSIS 配置选项](https://www.electron.build/configuration/nsis)
- [Electron 打包最佳实践](https://www.electronjs.org/docs/latest/tutorial/application-distribution)
