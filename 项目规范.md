# DNA Automator 项目开发规范

## 📋 目录结构规范

```
DNA-Automator/
├── electron/              # Electron主进程代码
│   ├── main.ts           # 主进程入口
│   ├── preload.ts        # 预加载脚本
│   └── tsconfig.json     # TypeScript配置
├── src/                  # Vue前端代码
│   ├── components/       # Vue组件
│   │   └── scripts/      # 脚本配置组件
│   ├── store/           # Pinia状态管理
│   ├── utils/           # 工具函数
│   ├── App.vue          # 根组件
│   └── main.ts          # 前端入口
├── py_engine/           # Python后端引擎
│   ├── main.py          # Python主入口
│   ├── window_capture.py    # 窗口捕获模块
│   ├── image_recognition.py # 图像识别模块
│   └── human_mouse.py       # 鼠标控制模块
├── python/              # 嵌入式Python环境
├── dist-electron/       # Electron编译输出
├── dist/                # Vue编译输出
└── mods/                # 脚本模组目录
```

## 🎯 代码规范

### TypeScript/Vue规范

1. **类型安全**
   - 所有函数参数和返回值必须有明确的类型定义
   - 避免使用`any`,优先使用具体类型或泛型
   - 使用接口(interface)定义复杂对象结构

2. **命名规范**
   - 组件名: PascalCase (例如: `Fire10Config.vue`)
   - 函数名: camelCase (例如: `handleStartListening`)
   - 常量名: UPPER_SNAKE_CASE (例如: `DEBOUNCE_DELAY`)
   - 变量名: camelCase (例如: `gameWindowConnected`)

3. **注释规范**
   - 所有公共函数必须有JSDoc注释
   - 复杂逻辑必须有行内注释说明
   - 组件必须有功能说明注释

4. **错误处理**
   - 所有异步操作必须有try-catch
   - 错误信息必须通过message工具统一显示
   - 错误日志必须包含上下文信息

### Python规范

1. **文档字符串**
   - 所有类和函数必须有docstring
   - 使用Google风格的docstring格式
   - 包含参数说明、返回值说明、异常说明

2. **命名规范**
   - 类名: PascalCase (例如: `WindowCapture`)
   - 函数名: snake_case (例如: `find_windows`)
   - 常量名: UPPER_SNAKE_CASE (例如: `MAX_RETRIES`)
   - 私有方法: 前缀下划线 (例如: `_init_backend`)

3. **日志规范**
   - 使用统一的log函数输出日志
   - 日志级别: DEBUG, INFO, WARN, ERROR
   - 日志格式: `[级别] 消息内容`
   - 关键操作必须有日志记录

4. **错误处理**
   - 所有可能失败的操作必须有try-except
   - 异常信息必须通过log函数输出
   - 关键错误必须包含traceback

## 🔄 通信协议规范

### Electron ↔ Python 通信

**命令格式 (Electron → Python)**:
```json
{
  "action": "命令名称",
  "参数1": "值1",
  "参数2": "值2"
}
```

**响应格式 (Python → Electron)**:
```json
{
  "type": "响应类型",
  "data": {
    "字段1": "值1",
    "字段2": "值2"
  }
}
```

**日志格式**:
```json
{
  "type": "log",
  "data": {
    "level": "INFO|WARN|ERROR|DEBUG",
    "message": "日志内容",
    "timestamp": 1234567890.123
  }
}
```

### 前端 ↔ Electron 通信

**使用IPC通信**:
- 单向消息: `ipcRenderer.send()` / `ipcMain.on()`
- 双向调用: `ipcRenderer.invoke()` / `ipcMain.handle()`

**命名规范**:
- 使用kebab-case命名IPC通道
- 例如: `save-config`, `enter-script-mode`

## 🧪 测试规范

### 开发测试流程

1. **功能开发完成后**
   - 手动测试所有功能路径
   - 测试异常情况和边界条件
   - 检查日志输出是否完整

2. **提交前检查**
   - 运行TypeScript类型检查: `npm run build`
   - 检查是否有未使用的变量和导入
   - 确保没有console.error或未处理的异常

3. **测试场景**
   - 正常启动和退出
   - 窗口检测和连接
   - 快捷键注册和触发
   - 脚本启动和停止
   - 配置保存和加载

## 📝 Git提交规范

### Commit Message格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构代码
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```
feat(window): 添加窗口自动检测功能

- 实现基于关键词的窗口搜索
- 自动过滤应用程序自身窗口
- 添加智能窗口选择逻辑

Closes #123
```

## 🚨 常见问题和最佳实践

### 1. 避免内存泄漏

**问题**: 事件监听器未清理
```typescript
// ❌ 错误: 重复注册监听器
onMounted(() => {
  window.electronAPI.onPythonData(callback)
})
```

**解决**:
```typescript
// ✅ 正确: 只注册一次,或在unmounted时清理
onMounted(() => {
  const unsubscribe = window.electronAPI.onPythonData(callback)
})

onUnmounted(() => {
  // 清理监听器
})
```

### 2. 避免状态不同步

**问题**: 前端和Python状态不一致
```typescript
// ❌ 错误: 只更新前端状态
isRunning.value = true
```

**解决**:
```typescript
// ✅ 正确: 同时更新前端和后端
isRunning.value = true
window.electronAPI.sendToPython({ action: 'start_script' })
```

### 3. 避免阻塞主线程

**问题**: 长时间运行的任务阻塞UI
```python
# ❌ 错误: 在主线程中执行长时间任务
def handle_command(cmd):
    if cmd['action'] == 'heavy_task':
        # 长时间运行的任务
        for i in range(1000000):
            process_data(i)
```

**解决**:
```python
# ✅ 正确: 使用线程处理长时间任务
def handle_command(cmd):
    if cmd['action'] == 'heavy_task':
        thread = threading.Thread(target=heavy_task_worker)
        thread.start()
```

### 4. 避免硬编码

**问题**: 配置值写死在代码中
```typescript
// ❌ 错误: 硬编码配置
const timeout = 300
```

**解决**:
```typescript
// ✅ 正确: 使用配置文件或状态管理
const timeout = store.scriptConfigs.fire10.timeout
```

### 5. 统一错误处理

**问题**: 错误处理不一致
```typescript
// ❌ 错误: 直接使用ElMessage
ElMessage.error('操作失败')
```

**解决**:
```typescript
// ✅ 正确: 使用封装的message工具
import { message } from '@/utils/message'
message.error('操作失败')
```

## 🔧 开发工具配置

### VSCode推荐插件

- Vue Language Features (Volar)
- TypeScript Vue Plugin (Volar)
- Python
- Pylance
- ESLint
- Prettier

### VSCode配置

```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": true
}
```

## 📚 参考资源

- [Electron官方文档](https://www.electronjs.org/docs)
- [Vue 3官方文档](https://vuejs.org/)
- [Pinia官方文档](https://pinia.vuejs.org/)
- [Element Plus文档](https://element-plus.org/)
- [Python官方文档](https://docs.python.org/3/)
- [OpenCV文档](https://docs.opencv.org/)

## 🎯 性能优化建议

### 前端优化

1. **组件懒加载**: 大型组件使用动态导入
2. **虚拟滚动**: 长列表使用虚拟滚动
3. **防抖节流**: 频繁触发的事件使用防抖或节流
4. **避免不必要的响应式**: 大数据对象使用`shallowRef`

### Python优化

1. **图像缓存**: 缓存常用的模板图像
2. **多线程**: 使用线程池处理并发任务
3. **GPU加速**: 支持CUDA/OpenCL加速图像识别
4. **内存管理**: 及时释放大对象,避免内存泄漏

## 🔐 安全规范

1. **输入验证**: 所有外部输入必须验证
2. **权限检查**: 敏感操作必须检查权限
3. **错误信息**: 不要在错误信息中暴露敏感信息
4. **依赖更新**: 定期更新依赖包,修复安全漏洞

## 📊 监控和日志

### 日志级别使用指南

- **DEBUG**: 详细的调试信息,仅开发环境使用
- **INFO**: 一般信息,记录正常的操作流程
- **WARN**: 警告信息,可能的问题但不影响运行
- **ERROR**: 错误信息,操作失败但程序可继续

### 关键操作必须记录日志

- 应用启动和退出
- 窗口检测和连接
- 脚本启动和停止
- 配置加载和保存
- 所有错误和异常

---

**最后更新**: 2024-12-10
**维护者**: DNA Automator Team
