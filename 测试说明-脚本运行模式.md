# 脚本运行模式测试说明

## 功能概述
新的脚本运行模式采用"按需监听"的设计,用户需要主动点击"开始监听"按钮才会进入脚本运行模式,此时才会监听停止快捷键。

## 测试步骤

### 1. 配置快捷键
1. 启动应用(以管理员身份运行)
2. 在"快捷键配置"面板中:
   - 点击"开始脚本快捷键"输入框,按下你想要的快捷键(例如: Ctrl+F1)
   - 点击"停止脚本快捷键"输入框,按下你想要的快捷键(例如: Ctrl+F2)
3. 点击"保存配置"按钮
4. 看到"配置保存成功"提示

**注意**: 此时快捷键还没有被注册,不会监听任何按键

### 2. 开始监听(进入脚本运行模式)
1. 在"控制面板"中,点击"开始监听"按钮
2. 应用会自动:
   - 检测游戏窗口(如果未连接)
   - 连接到游戏窗口
   - 置顶游戏窗口
   - 进入脚本运行模式
3. 看到以下变化:
   - 控制面板标题旁边显示"脚本运行模式"绿色标签
   - 显示提示:"当前处于脚本运行模式,按下停止快捷键可停止脚本并退出此模式"
   - "开始监听"按钮变为"停止监听"按钮(红色)
   - 底部显示:"当前正在监听停止快捷键: Ctrl+F2"

### 3. 测试停止快捷键
1. 在脚本运行模式下,按下你配置的停止快捷键(例如: Ctrl+F2)
2. 应用会自动:
   - 退出脚本运行模式
   - 注销所有快捷键监听
3. 看到以下变化:
   - "脚本运行模式"标签消失
   - 提示消失
   - "停止监听"按钮变回"开始监听"按钮(蓝色)
   - 看到消息:"脚本已停止,已退出脚本运行模式"

### 4. 手动停止监听
1. 在脚本运行模式下,点击"停止监听"按钮
2. 效果与按停止快捷键相同
3. 看到消息:"已退出脚本运行模式"

## 预期行为

### ✅ 正确行为
- 启动应用时不监听任何快捷键
- 保存配置时不监听任何快捷键
- 只有点击"开始监听"后才监听停止快捷键
- 在脚本运行模式下,按停止快捷键可以退出模式
- 退出脚本运行模式后,不再监听任何快捷键

### ❌ 错误行为(如果出现请报告)
- 启动应用时就开始监听快捷键
- 保存配置后自动开始监听
- 在非脚本运行模式下,快捷键仍然有效
- 退出脚本运行模式后,快捷键仍然有效

## 状态机流程图

```
┌─────────────┐
│  初始状态    │ ← 应用启动
│ (不监听)     │
└──────┬──────┘
       │
       │ 点击"开始监听"
       ↓
┌─────────────┐
│ 脚本运行模式 │ ← 监听停止快捷键
│ (监听中)     │
└──────┬──────┘
       │
       │ 按停止快捷键 或 点击"停止监听"
       ↓
┌─────────────┐
│  初始状态    │ ← 取消所有监听
│ (不监听)     │
└─────────────┘
```

## 技术细节

### 前端状态
- `store.isScriptMode`: 是否处于脚本运行模式
- `store.isRunning`: 脚本是否正在运行(暂未实现)

### Electron主进程
- `registerStopHotkey(stopKey)`: 注册停止快捷键
- `unregisterAllHotkeys()`: 注销所有快捷键

### IPC通信
- `enterScriptMode(stopKey)`: 前端 → 主进程,请求进入脚本运行模式
- `exitScriptMode()`: 前端 → 主进程,请求退出脚本运行模式
- `hotkey-triggered`: 主进程 → 前端,通知快捷键被触发

## 常见问题

### Q: 为什么要改成"按需监听"?
A: 之前的设计是"一直监听",可能导致:
- 用户不小心按到快捷键
- 快捷键与其他应用冲突
- 无法控制何时开始/停止监听

新设计让用户完全控制监听的时机,更加安全和可控。

### Q: 脚本运行模式和脚本运行有什么区别?
A: 
- **脚本运行模式** (`isScriptMode`): 表示应用正在监听停止快捷键,准备运行脚本
- **脚本运行** (`isRunning`): 表示脚本正在执行(暂未实现)

目前只实现了脚本运行模式,实际的脚本执行逻辑还在开发中。

### Q: 如果我忘记配置快捷键会怎样?
A: 点击"开始监听"时会提示:"请先配置并保存快捷键",不会进入脚本运行模式。
